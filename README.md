# Сервис для работы с ПВЗ
Данный сервис реализован на языке Go с использованием библиотеки Gin. Для работы с PostgreSQL м для миграций использовался драйвер pgx. 
Для миграции использовалась библиотека goose, миграции выполняются автоматически при запуске сервиса. Тип операции зависит от определенного запроса. Для данных из файла конфигурации используется Viper.
Реализован сервис, в котором имеется возможность создания ПВЗ, приемок товаров и добавления в них товаров, также доступны операции закрытия приемок, удаления товаров и получения сводки данных. Для пользования сервисов необходима авторизация и получение токена. Для токенов авторизации использовалось JWT
В Makefile прописаны возможные варианты запуска API и миграции. Приложение покрыто логами для информировани и дебага.
Для логгирования использовалась Zerolog. Логгируются информационные сообщения, ошибки, промежуточная информация на уровне debug.
Для интеграционного и unit тестирования использовались библиотеки и инструменты testcontainers-go, mockgen, go-sqlmock.
## Дополнительные задания
Из дополнительных заданий были реализованы:
1. Реализовать пользовательскую авторизацию по методам /register и /login 
   (при этом метод /dummyLogin все равно должен быть реализован).
2. Реализовать gRPC-метод, который просто вернёт все добавленные в систему ПВЗ. Для него не
   требуется проверка авторизации и валидация ролей пользователей. Сервер для gRPC должен быть запущен на порту 3000.
   Обратите внимание, что в файле [pvz.proto](pvz.proto) необходимо прописать go_package под вашу структуру проекта
3. Добавить в проект prometheus и собирать следующие метрики:
   * Технические: 
     * Количество запросов
     * Время ответа
   * Бизнесовые:
     * Количество созданных ПВЗ
     * Количество созданных приёмок заказов
     * Количество добавленных товаров
   Сервер для prometheus должен быть поднят на порту 9000 и отдавать данные по ручке /metrics.
4. Настроить логирование в проекте

gRPC клиент вызывается периодично раз в минуту и после выполнения вызова метода выводит результат запроса в логах сервиса. 
## Запуск приложения:
### Использование docker-compose.
   Для сборки и запуска приложения нужно ввести в консоль команду
   ```
   make build
   ```
   или эту команду
   ```
   docker-compose up --build
   ```
## Пользование сервисом
### 1. Авторизация и регистрация
#### Для прямого получения токена необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/dummyLogin' \
--header 'Content-Type: application/json' \
--data '{
    "role": "{moderator или employee}"
}'
```
В поле role нужно ввести одну из двух доступных ролей сотрудника ПВЗ или модератора. В ответ на запрос выдается токен для пользования сервисом.
#### Для отдельной регистрации необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/register' \
--header 'Content-Type: application/json' \
--data '{
    "email":"{email}",
    "password": "{password}",
    "role": "{moderator или employee}"
}'
```
Вместо email вводится желаемая почта, в поле password соответственно желаемый пароль. В поле role одну из двух доступных ролей сотрудника ПВЗ или модератора.
В ответ на запрос выдается почта и роль.
#### Для авторизации необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/login' \
--header 'Content-Type: application/json' \
--data '{
    "email":"{email}",
    "password": "123"
}'
```
Вместо email вводится выбранный нами при регистрации username, в поле password соответственно пароль. 
В ответ на данный запрос нам выдастся токен, который нужно сохранить и использовать во всех следующих запросах. В программе Postman имеется функционал, который позволяет один раз указать токен и выполнять все дальнейшие запросы уже с ним. В командной строке с каждым запросом придется указывать вручную заголовок.
Проверка токена в сервисе выполняется при помощи методов в Middleware.
Во всех запросах вместо Token в заголовке вводится личный токен, полученный при авторизации. 
### 2. ПВЗ
#### Для создания ПВЗ необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/pvz' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer {token}' \
--data '{
    "city": "{Москва или Санкт-Петербург или Казань}"
}'
```
Вместо city нужно ввести название одного из 3 доступных городов, после чего будет выведена структура нового созданного ПВЗ.
Создать ПВЗ может только пользователь с ролью moderator.
#### Для получения данных о ПВЗ необходимо выполнить запрос
```
curl --location --request GET 'http://localhost:8080/pvz?startDate={2025-04-14T15%3A30%3A00Z}&endDate={2025-04-14T15%3A30%3A00Z}&page=1&limit=10' \
--header 'Authorization: Bearer {token}' \
--data ''
```
Вместо startDate и endDate в запросе можно ввести желаемые даты для фильтрации. Вместо page и limit желаемые номер страницы и количество элементов на странице. Все эти параметры являются необязательными, и в случае отсутсвия будут применены значения по умолчанию.
### 3. Приемка и товары
#### Для добавления информации о приёмке товаров необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/receptions' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer {token}' \
--data '{
    "pvzId":"{pvzId}"
}'
```
Вместо pvzId вводится id ПВЗ в котором нам необходимо создать приемку. ID берется из структуры ПВЗ, полученной при его создании.
В результате успешного запроса нам выведется структура созданной приемки. Если же предыдущая приёмка товара не была закрыта, то операция по созданию нового приёма товаров невозможна.
Только авторизованный пользователь системы с ролью «сотрудник ПВЗ/employee» может инициировать приём товара.
#### Для добавления товаров в рамках одной приёмки необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/products' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer {token}' \
--data '{
    "pvzId":"{pvzId}",
    "type": "{одежда или электроника или обувь}"
}'
```
Вместо pvzId вводится id ПВЗ в который нам необходимо добавить товар. Вместо type желаемый тип товара, один из написанных трех. Только авторизованный пользователь системы с ролью «сотрудник ПВЗ/employee» может добавлять товары.
При этом товар привязывается к последнему незакрытому приёму товаров в рамках текущего ПВЗ.
Если же нет новой незакрытой приёмки товаров, то в таком случае возвращается ошибка, и товар не добавляется в систему.
В случае успешного запроса вернется структура добавленного товара.
#### Для удаления товаров в рамках не закрытой приёмки необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/pvz/{pvzId}/delete_last_product' \
--header 'Authorization: Bearer {token}' \
--data ''
```
Вместо pvzId вводится id ПВЗ в котором нам необходимо удалить товар. Удаляется последний добавленный товар по принципу LIFO. Только авторизованный пользователь системы с ролью «сотрудник ПВЗ/employee» может удалять товары. Удаление товара возможно только до закрытия приёмки, после этого уже невозможно изменить состав товаров, которые были приняты на ПВЗ. В случае успешного запроса вернется сообщение об удачном удалении.
#### Для закрытия приёмки необходимо выполнить запрос
```
curl --location --request POST 'http://localhost:8080/pvz/{pvzId}/close_last_reception' \
--header 'Authorization: Bearer {token}' \
--data ''
```
Вместо pvzId вводится id ПВЗ в котором нам необходимо закрыть приемку. Только авторизованный пользователь системы с ролью «сотрудник ПВЗ/employee» может закрывать приём товаров. В случае, если приёмка товаров уже была закрыта (или приёма товаров в данном ПВЗ ещё не было), то вернется ошибка. В случае успешного запроса вернется структура приемки с измененным статусом.
## Тестирование
Код покрыт unit-тестами, покрытие не менее 75%.

Также разработан один интеграционный тест, который:
* Первым делом создает новый ПВЗ
* Добавляет новую приёмку заказов
* Добавляет 50 товаров в рамках текущей приёмки заказов
* Закрывает приёмку заказов

Для запуска тестов необходимо ввести команду
```
go test -v ./...
```
Будет выведен процесс результат выполнения всех unit и интеграционного тестов.

Для краткого отображения необходимо ввести команду
```
go test ./...
```
Для работы интеграционного теста необходим запущенный Docker
## Метрики
По адресу http://localhost:9090/ , а также по /metrics, реализована выдача метрик Prometheus.
Для отображения метрик необходимо ввести в поиске 
Технические:
   * Количество запросов - http_requests_total
   * Время ответа - http_request_duration_seconds_bucket, http_request_duration_seconds_sum или http_request_duration_seconds_count
Бизнесовые:
   * Количество созданных ПВЗ - created_pvz_amount_total
   * Количество созданных приёмок заказов - created_receptions_amount_total
   * Количество добавленных товаров - added_products_amount_total
## Обработка ошибок
Для различных методов и вызовов функций реализована обработка ошибок, в зависимости от категории ошибки, выдается текст и формат ошибки.